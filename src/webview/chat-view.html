<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src #{cspSource} 'unsafe-inline'; script-src #{cspSource} 'unsafe-inline';">
    <title>Aider Chat</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            padding: 10px;
            margin: 0;
            background-color: var(--vscode-sideBar-background);
            color: var(--vscode-sideBar-foreground);
        }
        
        #inputBox {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
        }
        
        #inputBox:focus {
            outline: 1px solid var(--vscode-focusBorder);
            border-color: var(--vscode-focusBorder);
        }
        
        #sendButton, #sendFileButton {
            padding: 6px 12px;
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 11px;
        }
        
        #sendButton:hover, #sendFileButton:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        
        #terminal {
            height: 400px;
            width: 100%;
            padding: 8px;
            background-color: var(--vscode-terminal-background, #1e1e1e);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .button-container {
            display: flex;
            gap: 5px;
        }
        
        #modelSelect {
            margin-bottom: 10px;
            padding: 5px;
            width: 100%;
            font-size: 11px;
            background-color: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: 4px;
        }
        
        #modelSelect:focus {
            outline: 1px solid var(--vscode-focusBorder);
            border-color: var(--vscode-focusBorder);
        }
        
        /* Remove the old scrollbar styling since we're using xterm now */
    </style>
</head>
<body>
    <div>
        <label for="modelSelect">Model:</label>
        <select id="modelSelect">
            #{modelOptions}
        </select>
    </div>
    <div id="terminal"></div>
    <div class="input-container">
        <input id="inputBox" type="text" placeholder="Type your message to Aider...">
        <div class="button-container">
            <button id="sendButton">Send</button>
            <button id="sendFileButton">Send File</button>
        </div>
    </div>
    <script>
        (function() {
            let terminal = null;
            let fitAddon = null;
            let retryCount = 0;
            const maxRetries = 5;
            
            // Debounce utility function
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Initialize xterm terminal with debounced retry
            function initializeTerminal() {
                try {
                    console.log('Checking for xterm modules...');
                    console.log('Terminal:', typeof window.Terminal);
                    console.log('FitAddon:', typeof window.FitAddon);
                    console.log('window.FitAddon object:', window.FitAddon);
                    console.log('All window properties with "Fit":', Object.keys(window).filter(key => key.includes('Fit')));
                    
                    // Try different ways to access FitAddon
                    let FitAddonConstructor = null;
                    if (window.FitAddon) {
                        if (typeof window.FitAddon === 'function') {
                            FitAddonConstructor = window.FitAddon;
                        } else if (window.FitAddon.FitAddon && typeof window.FitAddon.FitAddon === 'function') {
                            FitAddonConstructor = window.FitAddon.FitAddon;
                        }
                    }
                    
                    console.log('FitAddonConstructor:', FitAddonConstructor);
                    
                    if (typeof window.Terminal !== 'undefined' && FitAddonConstructor) {
                        console.log('Creating xterm terminal...');
                        
                        terminal = new window.Terminal({
                            cursorBlink: true,
                            fontSize: 12,
                            fontFamily: 'Courier New, monospace',
                            theme: {
                                background: '#1e1e1e',
                                foreground: '#cccccc',
                                cursor: '#ffffff'
                            },
                            disableStdin: true,
                            convertEol: true
                        });
                        
                        fitAddon = new FitAddonConstructor();
                        terminal.loadAddon(fitAddon);
                        
                        const terminalElement = document.getElementById('terminal');
                        terminal.open(terminalElement);
                        fitAddon.fit();
                        
                        window.addEventListener('resize', debounce(() => {
                            if (fitAddon) {
                                fitAddon.fit();
                            }
                        }, 250));
                        
                        console.log('Xterm terminal initialized successfully');
                        retryCount = 0; // Reset retry count on success
                        return true;
                    } else {
                        console.warn('Xterm modules not available, retrying...');
                        scheduleRetry();
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to initialize xterm terminal:', error);
                    scheduleRetry();
                    return false;
                }
            }
            
            // Debounced retry with exponential backoff
            function scheduleRetry() {
                retryCount++;
                if (retryCount <= maxRetries) {
                    const delay = Math.min(1000 * Math.pow(2, retryCount - 1), 5000); // Cap at 5 seconds
                    console.log(`Scheduling retry ${retryCount}/${maxRetries} in ${delay}ms`);
                    setTimeout(initializeTerminal, delay);
                } else {
                    console.error('Max retries reached for xterm initialization');
                }
            }
            
            // Acquire VS Code API once
            const vscode = acquireVsCodeApi();
            
            // Cache DOM elements
            const inputBox = document.getElementById('inputBox');
            const sendButton = document.getElementById('sendButton');
            const sendFileButton = document.getElementById('sendFileButton');
            const modelSelect = document.getElementById('modelSelect');

            // Input validation
            function sanitizeInput(input) {
                return input.trim().substring(0, 1000); // Limit length
            }

            function sendMessage() {
                const text = sanitizeInput(inputBox.value);
                if (text) {
                    const model = modelSelect.value;
                    vscode.postMessage({ 
                        command: 'sendToAider', 
                        text: text, 
                        model: model 
                    });
                    
                    inputBox.value = '';
                }
            }

            // Event listeners
            sendButton.addEventListener('click', sendMessage);
            
            inputBox.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            sendFileButton.addEventListener('click', () => {
                vscode.postMessage({ command: 'sendCurrentFile' });
            });

            // Message handling from extension
            window.addEventListener('message', event => {
                const message = event.data;
                if (message.command === 'updateConversation') {
                    if (terminal) {
                        terminal.write(message.text);
                        console.log('Wrote to xterm terminal');
                    } else {
                        console.log('Terminal not ready:', message.text);
                    }
                }
            });
            
            // Initialize when ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeTerminal);
            } else {
                initializeTerminal();
            }
        })();
    </script>
</body>
</html>
